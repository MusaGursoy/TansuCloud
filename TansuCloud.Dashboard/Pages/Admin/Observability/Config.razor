@page "/admin/observability/config"
@using System.Net.Http.Json
@using TansuCloud.Dashboard.Models
@using MudBlazor
@attribute [Authorize(Policy = "AdminOnly")]
@layout AdminLayout
@inject IHttpClientFactory HttpClientFactory
@inject ILogger<Config> Logger
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<PageTitle>Observability Configuration | TansuCloud Admin</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-2">Observability Configuration</MudText>
    <MudText Typo="Typo.body1" Color="Color.Default" Class="mb-4">
        Configure retention, sampling, and alert SLO templates for SigNoz observability.
    </MudText>

    @if (_loading)
    {
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
    }
    else if (_config != null)
    {
        <MudGrid>
            <!-- Retention Configuration -->
            <MudItem xs="12" md="4">
                <MudCard Elevation="2">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">Retention Periods</MudText>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudNumericField T="int" 
                                       Value="@_config.RetentionDays.Traces"
                                       ValueChanged="@(v => _config = _config with { RetentionDays = _config.RetentionDays with { Traces = v } })"
                                       Label="Traces (days)" 
                                       Min="1" Max="365" 
                                       Variant="Variant.Outlined"
                                       HelperText="How long to keep trace data in ClickHouse"
                                       Class="mb-3" />

                        <MudNumericField T="int"
                                       Value="@_config.RetentionDays.Logs"
                                       ValueChanged="@(v => _config = _config with { RetentionDays = _config.RetentionDays with { Logs = v } })"
                                       Label="Logs (days)" 
                                       Min="1" Max="365" 
                                       Variant="Variant.Outlined"
                                       HelperText="How long to keep log data in ClickHouse"
                                       Class="mb-3" />

                        <MudNumericField T="int"
                                       Value="@_config.RetentionDays.Metrics"
                                       ValueChanged="@(v => _config = _config with { RetentionDays = _config.RetentionDays with { Metrics = v } })"
                                       Label="Metrics (days)" 
                                       Min="1" Max="365" 
                                       Variant="Variant.Outlined"
                                       HelperText="How long to keep metric data in ClickHouse"
                                       Class="mb-3" />

                        <MudAlert Severity="Severity.Info" Dense="true" Class="mt-2">
                            <strong>Note:</strong> Retention affects disk usage. Development defaults are 7 days for traces/logs, 14 days for metrics.
                        </MudAlert>
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <!-- Sampling Configuration -->
            <MudItem xs="12" md="4">
                <MudCard Elevation="2">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">Sampling</MudText>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudNumericField T="double"
                                       Value="@_config.Sampling.TraceRatio"
                                       ValueChanged="@(v => _config = _config with { Sampling = _config.Sampling with { TraceRatio = v } })"
                                       Label="Trace Sampling Ratio" 
                                       Min="0" Max="1" 
                                       Step="0.1"
                                       Variant="Variant.Outlined"
                                       HelperText="Head-based sampling rate (0.0 = none, 1.0 = all traces)"
                                       Class="mb-3" />

                        <MudAlert Severity="Severity.Info" Dense="true" Class="mb-3">
                            <strong>Current:</strong> @(GetSamplingDescription(_config.Sampling.TraceRatio))
                        </MudAlert>

                        <MudAlert Severity="Severity.Warning" Dense="true">
                            <strong>Production tip:</strong> Set to 0.1 (10%) or lower to reduce costs while maintaining observability for errors.
                        </MudAlert>
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <!-- Alert SLOs Summary -->
            <MudItem xs="12" md="4">
                <MudCard Elevation="2">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">Alert SLO Templates</MudText>
                        </CardHeaderContent>
                        <CardHeaderActions>
                            <MudIconButton Icon="@Icons.Material.Filled.Add" 
                                         Color="Color.Primary" 
                                         OnClick="@(() => OpenAlertDialog(null))"
                                         Size="Size.Small" />
                        </CardHeaderActions>
                    </MudCardHeader>
                    <MudCardContent>
                        @if (_config.AlertSLOs.Any())
                        {
                            <MudText Typo="Typo.body2" Class="mb-3">
                                <strong>@_config.AlertSLOs.Count</strong> alert SLO templates configured
                            </MudText>

                            <MudList T="string" Dense="true">
                                @foreach (var alert in _config.AlertSLOs)
                                {
                                    <MudListItem T="string">
                                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Start" Class="full-width">
                                            <MudStack Spacing="1">
                                                <MudText Typo="Typo.subtitle2">@alert.Service</MudText>
                                                <MudText Typo="Typo.caption">@alert.Description</MudText>
                                                <MudText Typo="Typo.caption" Color="Color.Default">
                                                    Window: @alert.WindowMinutes min | Threshold: @alert.Threshold @alert.Comparison
                                                </MudText>
                                            </MudStack>
                                            <MudChip T="string" Size="Size.Small" Color="Color.Secondary">@alert.Kind</MudChip>
                                        </MudStack>
                                    </MudListItem>
                                }
                            </MudList>
                        }
                        else
                        {
                            <MudText Typo="Typo.body2" Color="Color.Default">No alert SLO templates configured.</MudText>
                        }
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <!-- Alert SLOs Detailed Table -->
            @if (_config.AlertSLOs.Any())
            {
                <MudItem xs="12" Class="mt-4">
                    <MudCard Elevation="2">
                        <MudCardHeader>
                            <CardHeaderContent>
                                <MudText Typo="Typo.h6">Alert SLO Details</MudText>
                            </CardHeaderContent>
                        </MudCardHeader>
                        <MudCardContent>
                            <MudDataGrid T="AlertSloTemplate" 
                                        Items="@_config.AlertSLOs" 
                                        Filterable="true" 
                                        Dense="true"
                                        Hover="true">
                                <Columns>
                                    <PropertyColumn Property="x => x.Id" Title="ID">
                                        <CellTemplate>
                                            <MudText Typo="Typo.body2"><code>@context.Item.Id</code></MudText>
                                        </CellTemplate>
                                    </PropertyColumn>
                                    <PropertyColumn Property="x => x.Service" Title="Service" />
                                    <PropertyColumn Property="x => x.Kind" Title="Kind">
                                        <CellTemplate>
                                            <MudChip Size="Size.Small" Color="Color.Info">@context.Item.Kind</MudChip>
                                        </CellTemplate>
                                    </PropertyColumn>
                                    <PropertyColumn Property="x => x.Description" Title="Description" />
                                    <PropertyColumn Property="x => x.WindowMinutes" Title="Window">
                                        <CellTemplate>
                                            @context.Item.WindowMinutes min
                                        </CellTemplate>
                                    </PropertyColumn>
                                    <PropertyColumn Property="x => x.Threshold" Title="Threshold" />
                                    <PropertyColumn Property="x => x.Comparison" Title="Comparison" />
                                </Columns>
                            </MudDataGrid>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            }

            <!-- Action Buttons -->
            <MudItem xs="12" Class="mt-4">
                <MudPaper Elevation="0" Class="d-flex gap-2">
                    <MudButton Variant="Variant.Filled" 
                              Color="Color.Primary" 
                              StartIcon="@Icons.Material.Filled.Save"
                              OnClick="SaveConfig" 
                              Disabled="@_loading">
                        Save Configuration
                    </MudButton>
                    
                    <MudButton Variant="Variant.Outlined" 
                              Color="Color.Default" 
                              StartIcon="@Icons.Material.Filled.Refresh"
                              OnClick="RefreshConfig" 
                              Disabled="@_loading">
                        Refresh
                    </MudButton>
                </MudPaper>
            </MudItem>

            <!-- Important Notes -->
            <MudItem xs="12" Class="mt-2">
                <MudAlert Severity="Severity.Info">
                    <MudText Typo="Typo.subtitle2" Class="mb-2">
                        <strong>Important:</strong> After saving, changes will take effect after running the 'SigNoz: governance (apply)' task.
                    </MudText>
                    <MudText Typo="Typo.body2">
                        Changes affect ClickHouse TTL policies and SigNoz sampling configuration.
                        See <code>Guide-For-Admins-and-Tenants.md</code> section 6.5 for detailed documentation.
                    </MudText>
                </MudAlert>
            </MudItem>
        </MudGrid>
    }
</MudContainer>

@code {
    private bool _loading = true;
    private string? _errorMessage;
    private ObservabilityGovernanceConfig? _config;

    protected override async Task OnInitializedAsync()
    {
        await LoadConfig();
    } // End of Method OnInitializedAsync

    private async Task LoadConfig()
    {
        _loading = true;
        _errorMessage = null;

        try
        {
            var client = HttpClientFactory.CreateClient("Gateway");
            var response = await client.GetAsync("/admin/api/observability/governance");

            if (response.IsSuccessStatusCode)
            {
                _config = await response.Content.ReadFromJsonAsync<ObservabilityGovernanceConfig>();
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.NotFound)
            {
                // Graceful handling: API endpoint not implemented yet
                _errorMessage = "Observability configuration API endpoint is not yet implemented. This feature is coming soon.";
                Logger.LogInformation("Observability configuration API endpoint not found (expected for placeholder page)");
            }
            else
            {
                var problemDetails = await response.Content.ReadAsStringAsync();
                _errorMessage = $"Failed to load observability configuration: {response.StatusCode}";
                Logger.LogWarning("Failed to load observability configuration: {StatusCode}, {Details}", 
                    response.StatusCode, problemDetails);
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error loading observability configuration: {ex.Message}";
            Logger.LogError(ex, "Error loading observability configuration");
        }
        finally
        {
            _loading = false;
        }
    } // End of Method LoadConfig

    private async Task RefreshConfig()
    {
        await LoadConfig();
    } // End of Method RefreshConfig

    private async Task SaveConfig()
    {
        if (_config == null) return;

        _loading = true;
        try
        {
            var client = HttpClientFactory.CreateClient("Gateway");
            var response = await client.PostAsJsonAsync("/admin/api/observability/governance", _config);

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<SaveConfigResult>();
                Snackbar.Add(result?.Message ?? "Configuration saved successfully!", Severity.Success);
                Logger.LogInformation("Observability configuration saved successfully");
            }
            else
            {
                var problemDetails = await response.Content.ReadAsStringAsync();
                Snackbar.Add($"Failed to save configuration: {response.StatusCode}", Severity.Error);
                Logger.LogWarning("Failed to save observability configuration: {StatusCode}, {Details}", 
                    response.StatusCode, problemDetails);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving configuration: {ex.Message}", Severity.Error);
            Logger.LogError(ex, "Error saving observability configuration");
        }
        finally
        {
            _loading = false;
        }
    } // End of Method SaveConfig

    private Task OpenAlertDialog(AlertSloTemplate? alert)
    {
        // TODO: Implement alert SLO editor dialog
        Snackbar.Add("Alert SLO editor coming soon!", Severity.Info);
        return Task.CompletedTask;
    } // End of Method OpenAlertDialog

    private string GetSamplingDescription(double ratio)
    {
        return ratio switch
        {
            1.0 => "100% - All traces captured (development default)",
            >= 0.5 => $"{ratio * 100:F0}% - High sampling rate",
            >= 0.1 => $"{ratio * 100:F0}% - Moderate sampling rate",
            > 0 => $"{ratio * 100:F1}% - Low sampling rate (production recommended)",
            _ => "0% - No traces captured"
        };
    }

    private record SaveConfigResult(string Message, string FilePath);
}
