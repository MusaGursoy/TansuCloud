@page "/admin/identity-policies"
@using System.Net.Http.Json
@using System.Text.Json
@attribute [Authorize(Policy = "AdminOnly")]
@layout TansuCloud.Dashboard.Pages.Admin.AdminLayout
@inject IHttpClientFactory HttpClientFactory
@inject ILogger<IdentityPolicies> Logger

<PageTitle>Identity Policies | TansuCloud Admin</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <h2>Identity Policies</h2>
    <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-4">
        Configure password requirements, lockout settings, and token lifetimes.
    </MudText>

    @if (!string.IsNullOrWhiteSpace(_errorMessage))
    {
        <MudAlert Severity="Severity.Error" ShowCloseIcon="true" CloseIconClicked="@(() => _errorMessage = null)" Class="mb-4 alert-danger">
            <strong>Error:</strong> @_errorMessage
        </MudAlert>
    }

    @if (_loading)
    {
        <div class="d-flex justify-content-center py-5">
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
        </div>
    }
    else if (_config != null)
    {
        <MudGrid>
            <!-- Password Policy -->
            <MudItem xs="12" lg="6">
                <MudCard Elevation="2">
                    <MudCardHeader Style="background-color: var(--mud-palette-primary); color: white;">
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">Password Policy</MudText>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudNumericField T="int" Label="Minimum Length" 
                                         Value="@_editConfig.Password.RequiredLength"
                                         ValueChanged="@((int value) => _editConfig.Password.RequiredLength = value)"
                                         Min="1" Max="128" 
                                         Disabled="@(!_editMode)"
                                         HelperText="Minimum number of characters required (1-128)"
                                         Variant="Variant.Outlined" Class="mb-3"
                                         id="passwordLength" />

                        <MudCheckBox T="bool" @bind-Value="_editConfig.Password.RequireDigit" 
                                     Disabled="@(!_editMode)" Color="Color.Primary" Class="mb-2">
                            Require digit (0-9)
                        </MudCheckBox>

                        <MudCheckBox T="bool" @bind-Value="_editConfig.Password.RequireUppercase" 
                                     Disabled="@(!_editMode)" Color="Color.Primary" Class="mb-2">
                            Require uppercase letter (A-Z)
                        </MudCheckBox>

                        <MudCheckBox T="bool" @bind-Value="_editConfig.Password.RequireLowercase" 
                                     Disabled="@(!_editMode)" Color="Color.Primary" Class="mb-2">
                            Require lowercase letter (a-z)
                        </MudCheckBox>

                        <MudCheckBox T="bool" @bind-Value="_editConfig.Password.RequireNonAlphanumeric" 
                                     Disabled="@(!_editMode)" Color="Color.Primary">
                            Require special character (!@@##$$%%^^&&*...)
                        </MudCheckBox>
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <!-- Lockout Policy -->
            <MudItem xs="12" lg="6">
                <MudCard Elevation="2">
                    <MudCardHeader Style="background-color: var(--mud-palette-warning); color: white;">
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">Account Lockout</MudText>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudCheckBox T="bool" @bind-Value="_editConfig.Lockout.Enabled" 
                                     Disabled="@(!_editMode)" Color="Color.Primary" Class="mb-3">
                            Enable account lockout after failed attempts
                        </MudCheckBox>

                        <MudNumericField T="int" Label="Max Failed Attempts" 
                                         Value="@_editConfig.Lockout.MaxFailedAttempts"
                                         ValueChanged="@((int value) => _editConfig.Lockout.MaxFailedAttempts = value)"
                                         Min="1" Max="100" 
                                         Disabled="@(!_editMode || !_editConfig.Lockout.Enabled)"
                                         HelperText="Number of failed sign-in attempts before lockout"
                                         Variant="Variant.Outlined" Class="mb-3" />

                        <MudNumericField T="int" Label="Lockout Duration (minutes)" 
                                         Value="@_editConfig.Lockout.DurationMinutes"
                                         ValueChanged="@((int value) => _editConfig.Lockout.DurationMinutes = value)"
                                         Min="1" Max="43200" 
                                         Disabled="@(!_editMode || !_editConfig.Lockout.Enabled)"
                                         HelperText="How long users are locked out (1-43200 minutes = 1 month)"
                                         Variant="Variant.Outlined" />
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <!-- Token Lifetimes -->
            <MudItem xs="12">
                <MudCard Elevation="2">
                    <MudCardHeader Style="background-color: var(--mud-palette-info); color: white;">
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">Token Lifetimes</MudText>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudGrid>
                            <MudItem xs="12" md="6">
                                <MudNumericField T="int" Label="Access Token Lifetime (seconds)" 
                                                 Value="@_editConfig.Tokens.AccessTokenLifetimeSeconds"
                                                 ValueChanged="@((int value) => _editConfig.Tokens.AccessTokenLifetimeSeconds = value)"
                                                 Min="60" Max="86400" 
                                                 Disabled="@(!_editMode)"
                                                 HelperText="How long access tokens are valid (60s - 24h)"
                                                 Variant="Variant.Outlined" />
                            </MudItem>

                            <MudItem xs="12" md="6">
                                <MudNumericField T="int" Label="Refresh Token Lifetime (seconds)" 
                                                 Value="@_editConfig.Tokens.RefreshTokenLifetimeSeconds"
                                                 ValueChanged="@((int value) => _editConfig.Tokens.RefreshTokenLifetimeSeconds = value)"
                                                 Min="3600" Max="7776000" 
                                                 Disabled="@(!_editMode)"
                                                 HelperText="How long refresh tokens are valid (1h - 90d)"
                                                 Variant="Variant.Outlined" />
                            </MudItem>
                        </MudGrid>
                    </MudCardContent>
                </MudCard>
            </MudItem>
        </MudGrid>

        <!-- Action Buttons -->
        <MudPaper Elevation="0" Class="mt-4">
            <MudAlert Severity="Severity.Info" Class="mb-4">
                <strong>Note:</strong> Changes to identity policies require an Identity service restart to take effect. 
                After modifying these settings in the configuration, restart the service to apply changes.
            </MudAlert>

            @if (!_editMode)
            {
                <MudButton Variant="Variant.Filled" Color="Color.Primary" 
                           OnClick="EnableEditMode" Disabled="@_saving"
                           StartIcon="@Icons.Material.Filled.Edit">
                    Edit Policies
                </MudButton>
            }
            else
            {
                <MudButton Variant="Variant.Filled" Color="Color.Success" 
                           OnClick="SaveChanges" Disabled="@_saving" Class="me-2"
                           StartIcon="@Icons.Material.Filled.CheckCircle">
                    @if (_saving)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="me-1" />
                    }
                    Save Changes
                </MudButton>
                <MudButton Variant="Variant.Filled" Color="Color.Default" 
                           OnClick="CancelEdit" Disabled="@_saving"
                           StartIcon="@Icons.Material.Filled.Cancel">
                    Cancel
                </MudButton>
            }

            <MudButton Variant="Variant.Outlined" Color="Color.Default" 
                       OnClick="RefreshConfig" Disabled="@(_saving || _editMode)" Class="ms-2"
                       StartIcon="@Icons.Material.Filled.Refresh">
                Refresh
            </MudButton>
        </MudPaper>
    }
</MudContainer>

@code {
    private bool _loading = true;
    private bool _editMode = false;
    private bool _saving = false;
    private string? _errorMessage;
    private IdentityPoliciesViewModel? _config;
    private IdentityPoliciesViewModel _editConfig = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadConfig();
    }

    private async Task LoadConfig()
    {
        _loading = true;
        _errorMessage = null;

        try
        {
            var client = HttpClientFactory.CreateClient("Gateway");
            var response = await client.GetAsync("/identity/admin/api/identity/policies");

            if (response.IsSuccessStatusCode)
            {
                var json = await response.Content.ReadFromJsonAsync<JsonElement>();
                _config = new IdentityPoliciesViewModel
                {
                    Password = new PasswordPolicyViewModel
                    {
                        RequiredLength = json.GetProperty("password").GetProperty("requiredLength").GetInt32(),
                        RequireDigit = json.GetProperty("password").GetProperty("requireDigit").GetBoolean(),
                        RequireUppercase = json.GetProperty("password").GetProperty("requireUppercase").GetBoolean(),
                        RequireLowercase = json.GetProperty("password").GetProperty("requireLowercase").GetBoolean(),
                        RequireNonAlphanumeric = json.GetProperty("password").GetProperty("requireNonAlphanumeric").GetBoolean()
                    },
                    Lockout = new LockoutPolicyViewModel
                    {
                        Enabled = json.GetProperty("lockout").GetProperty("enabled").GetBoolean(),
                        MaxFailedAttempts = json.GetProperty("lockout").GetProperty("maxFailedAttempts").GetInt32(),
                        DurationMinutes = json.GetProperty("lockout").GetProperty("durationMinutes").GetInt32()
                    },
                    Tokens = new TokenLifetimesViewModel
                    {
                        AccessTokenLifetimeSeconds = json.GetProperty("tokens").GetProperty("accessTokenLifetimeSeconds").GetInt32(),
                        RefreshTokenLifetimeSeconds = json.GetProperty("tokens").GetProperty("refreshTokenLifetimeSeconds").GetInt32()
                    }
                };

                // Initialize edit config with current values
                _editConfig = _config.Clone();
            }
            else
            {
                _errorMessage = $"Failed to load identity policies: {response.StatusCode}";
                Logger.LogWarning("Failed to load identity policies: {StatusCode}", response.StatusCode);
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error loading identity policies: {ex.Message}";
            Logger.LogError(ex, "Error loading identity policies");
        }
        finally
        {
            _loading = false;
        }
    }

    private void EnableEditMode()
    {
        _editMode = true;
        _editConfig = _config!.Clone();
    }

    private void CancelEdit()
    {
        _editMode = false;
        _editConfig = _config!.Clone();
        _errorMessage = null;
    }

    private async Task SaveChanges()
    {
        _saving = true;
        _errorMessage = null;

        try
        {
            // Validate inputs
            if (_editConfig.Password.RequiredLength < 1 || _editConfig.Password.RequiredLength > 128)
            {
                _errorMessage = "Password length must be between 1 and 128 characters.";
                return;
            }

            if (_editConfig.Lockout.Enabled)
            {
                if (_editConfig.Lockout.MaxFailedAttempts < 1 || _editConfig.Lockout.MaxFailedAttempts > 100)
                {
                    _errorMessage = "Max failed attempts must be between 1 and 100.";
                    return;
                }

                if (_editConfig.Lockout.DurationMinutes < 1 || _editConfig.Lockout.DurationMinutes > 43200)
                {
                    _errorMessage = "Lockout duration must be between 1 and 43200 minutes (30 days).";
                    return;
                }
            }

            if (_editConfig.Tokens.AccessTokenLifetimeSeconds < 60 || _editConfig.Tokens.AccessTokenLifetimeSeconds > 86400)
            {
                _errorMessage = "Access token lifetime must be between 60 seconds (1 min) and 86400 seconds (24 hours).";
                return;
            }

            if (_editConfig.Tokens.RefreshTokenLifetimeSeconds < 3600 || _editConfig.Tokens.RefreshTokenLifetimeSeconds > 7776000)
            {
                _errorMessage = "Refresh token lifetime must be between 3600 seconds (1 hour) and 7776000 seconds (90 days).";
                return;
            }

            var client = HttpClientFactory.CreateClient("Gateway");
            var response = await client.PostAsJsonAsync("/identity/admin/api/identity/policies", _editConfig);

            if (response.StatusCode == System.Net.HttpStatusCode.NotImplemented)
            {
                _errorMessage = "Identity policy updates require service restart. Please update configuration and restart the Identity service.";
                Logger.LogWarning("Attempted to update identity policies via API (not implemented)");
            }
            else if (!response.IsSuccessStatusCode)
            {
                _errorMessage = $"Failed to save identity policies: {response.StatusCode}";
                Logger.LogWarning("Failed to save identity policies: {StatusCode}", response.StatusCode);
            }
            else
            {
                _config = _editConfig.Clone();
                _editMode = false;
                Logger.LogInformation("Identity policies updated successfully (restart required)");
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error saving identity policies: {ex.Message}";
            Logger.LogError(ex, "Error saving identity policies");
        }
        finally
        {
            _saving = false;
        }
    }

    private async Task RefreshConfig()
    {
        await LoadConfig();
    }

    // View Models
    private class IdentityPoliciesViewModel
    {
        public PasswordPolicyViewModel Password { get; set; } = new();
        public LockoutPolicyViewModel Lockout { get; set; } = new();
        public TokenLifetimesViewModel Tokens { get; set; } = new();

        public IdentityPoliciesViewModel Clone()
        {
            return new IdentityPoliciesViewModel
            {
                Password = new PasswordPolicyViewModel
                {
                    RequiredLength = Password.RequiredLength,
                    RequireDigit = Password.RequireDigit,
                    RequireUppercase = Password.RequireUppercase,
                    RequireLowercase = Password.RequireLowercase,
                    RequireNonAlphanumeric = Password.RequireNonAlphanumeric
                },
                Lockout = new LockoutPolicyViewModel
                {
                    Enabled = Lockout.Enabled,
                    MaxFailedAttempts = Lockout.MaxFailedAttempts,
                    DurationMinutes = Lockout.DurationMinutes
                },
                Tokens = new TokenLifetimesViewModel
                {
                    AccessTokenLifetimeSeconds = Tokens.AccessTokenLifetimeSeconds,
                    RefreshTokenLifetimeSeconds = Tokens.RefreshTokenLifetimeSeconds
                }
            };
        }
    }
private class PasswordPolicyViewModel
    {
        public int RequiredLength { get; set; }
        public bool RequireDigit { get; set; }
        public bool RequireUppercase { get; set; }
        public bool RequireLowercase { get; set; }
        public bool RequireNonAlphanumeric { get; set; }
    }
private class LockoutPolicyViewModel
    {
        public bool Enabled { get; set; }
        public int MaxFailedAttempts { get; set; }
        public int DurationMinutes { get; set; }
    }
private class TokenLifetimesViewModel
    {
        public int AccessTokenLifetimeSeconds { get; set; }
        public int RefreshTokenLifetimeSeconds { get; set; }
    }
}