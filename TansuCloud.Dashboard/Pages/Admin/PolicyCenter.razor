@page "/admin/policy-center"
@using System.Net.Http.Json
@using System.Text.Json
@attribute [Authorize(Policy = "AdminOnly")]
@layout TansuCloud.Dashboard.Pages.Admin.AdminLayout
@inject IHttpClientFactory HttpClientFactory
@inject ILogger<PolicyCenter> Logger
@inject IDialogService DialogService

<PageTitle>Policy Center | TansuCloud Admin</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <div class="d-flex justify-content-between align-items-start mb-4">
        <div>
            <h2>Policy Center</h2>
            <MudText Typo="Typo.body1" Color="Color.Secondary">
                Manage CORS and IP allow/deny policies with staged rollout.
            </MudText>
        </div>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" 
                   OnClick="ShowCreateDialog" StartIcon="@Icons.Material.Filled.AddCircle"
                   data-testid="btn-create-policy">
            Create Policy
        </MudButton>
    </div>

    @if (!string.IsNullOrWhiteSpace(_errorMessage))
    {
        <MudAlert Severity="Severity.Error" ShowCloseIcon="true" CloseIconClicked="@(() => _errorMessage = null)" Class="mb-4 alert alert-danger">
            <strong>Error:</strong> @_errorMessage
        </MudAlert>
    }

    @if (!string.IsNullOrWhiteSpace(_successMessage))
    {
        <MudAlert Severity="Severity.Success" ShowCloseIcon="true" CloseIconClicked="@(() => _successMessage = null)" Class="mb-4 alert alert-success">
            <strong>Success:</strong> @_successMessage
        </MudAlert>
    }

    <!-- Filters -->
    <MudGrid Class="mb-4">
        <MudItem xs="12" md="4">
            <MudSelect T="string" @bind-Value="_filterType" Label="Filter by Type" Variant="Variant.Outlined" data-testid="filter-type">
                <MudSelectItem Value="@("")">All Types</MudSelectItem>
                <MudSelectItem Value="@("Cors")">CORS</MudSelectItem>
                <MudSelectItem Value="@("IpAllow")">IP Allow</MudSelectItem>
                <MudSelectItem Value="@("IpDeny")">IP Deny</MudSelectItem>
            </MudSelect>
        </MudItem>
        <MudItem xs="12" md="4">
            <MudSelect T="string" @bind-Value="_filterMode" Label="Filter by Mode" Variant="Variant.Outlined">
                <MudSelectItem Value="@("")">All Modes</MudSelectItem>
                <MudSelectItem Value="@("Shadow")">Shadow</MudSelectItem>
                <MudSelectItem Value="@("AuditOnly")">Audit Only</MudSelectItem>
                <MudSelectItem Value="@("Enforce")">Enforce</MudSelectItem>
            </MudSelect>
        </MudItem>
        <MudItem xs="12" md="4" Class="d-flex align-items-end gap-2">
            <MudButton Variant="Variant.Filled" Color="Color.Default" 
                       OnClick="ApplyFilters" StartIcon="@Icons.Material.Filled.FilterList">
                Apply Filters
            </MudButton>
            <MudButton Variant="Variant.Outlined" Color="Color.Default" 
                       OnClick="ClearFilters" StartIcon="@Icons.Material.Filled.Clear">
                Clear
            </MudButton>
        </MudItem>
    </MudGrid>

    @if (_loading)
    {
        <div class="d-flex justify-content-center py-5">
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
        </div>
    }
    else if (_policies != null && _filteredPolicies.Any())
    {
        <!-- Policy List -->
        <MudTable T="PolicyViewModel" Items="@_filteredPolicies" Hover="true" Dense="true" Elevation="2">
            <HeaderContent>
                <MudTh>ID</MudTh>
                <MudTh>Type</MudTh>
                <MudTh>Mode</MudTh>
                <MudTh>Description</MudTh>
                <MudTh>Updated</MudTh>
                <MudTh Style="text-align: right;">Actions</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="ID"><code>@context.Id</code></MudTd>
                <MudTd DataLabel="Type">
                    <MudChip T="string" Size="Size.Small" Color="@GetTypeColor(context.Type)">@context.Type</MudChip>
                </MudTd>
                <MudTd DataLabel="Mode">
                    <MudChip T="string" Size="Size.Small" Color="@GetModeColor(context.Mode)">@context.Mode</MudChip>
                </MudTd>
                <MudTd DataLabel="Description">@context.Description</MudTd>
                <MudTd DataLabel="Updated">@context.UpdatedAt.ToString("yyyy-MM-dd HH:mm")</MudTd>
                <MudTd DataLabel="Actions" Style="text-align: right;">
                    <MudButton Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Small" 
                               OnClick="@(() => ShowEditDialog(context))" 
                               StartIcon="@Icons.Material.Filled.Edit" Class="me-1">
                        Edit
                    </MudButton>
                    <MudButton Variant="Variant.Outlined" Color="Color.Error" Size="Size.Small" 
                               OnClick="@(() => ShowDeleteConfirm(context))" 
                               StartIcon="@Icons.Material.Filled.Delete">
                        Delete
                    </MudButton>
                </MudTd>
            </RowTemplate>
        </MudTable>
    }
    else
    {
        <MudAlert Severity="Severity.Info">
            No policies found. Click "Create Policy" to add your first policy.
        </MudAlert>
    }

    <!-- Legend -->
    <MudPaper Elevation="0" Class="mt-4 pa-4">
        <h5>Enforcement Modes:</h5>
        <ul>
            <li>
                <MudIcon Icon="@Icons.Material.Filled.Circle" Color="Color.Default" Size="Size.Small" />
                <strong>Shadow</strong>: Policy evaluated but not enforced; violations logged for analysis.
            </li>
            <li>
                <MudIcon Icon="@Icons.Material.Filled.Circle" Color="Color.Warning" Size="Size.Small" />
                <strong>Audit Only</strong>: Policy evaluated, violations logged and alerted, but not blocked.
            </li>
            <li>
                <MudIcon Icon="@Icons.Material.Filled.Circle" Color="Color.Error" Size="Size.Small" />
                <strong>Enforce</strong>: Policy actively enforced; violations blocked.
            </li>
        </ul>
    </MudPaper>
</MudContainer>

@code {
    private bool _loading = true;
    private bool _saving = false;
    private bool _deleting = false;
    private string? _errorMessage;
    private string? _successMessage;
    private List<PolicyViewModel>? _policies;
    private List<PolicyViewModel> _filteredPolicies = new();
    private string _filterType = "";
    private string _filterMode = "";

    private PolicyViewModel? _editingPolicy;
    private PolicyViewModel? _deletingPolicy;

    protected override async Task OnInitializedAsync()
    {
        await LoadPolicies();
    }

    private async Task LoadPolicies()
    {
        _loading = true;
        _errorMessage = null;

        try
        {
            var client = HttpClientFactory.CreateClient("Gateway");
            var response = await client.GetAsync("/admin/api/policies");

            if (response.IsSuccessStatusCode)
            {
                var json = await response.Content.ReadFromJsonAsync<JsonElement>();
                _policies = new List<PolicyViewModel>();

                if (json.ValueKind == JsonValueKind.Array)
                {
                    foreach (var item in json.EnumerateArray())
                    {
                        _policies.Add(new PolicyViewModel
                        {
                            Id = item.GetProperty("id").GetString() ?? "",
                            Type = item.GetProperty("type").GetString() ?? "",
                            Mode = item.GetProperty("mode").GetString() ?? "",
                            Description = item.TryGetProperty("description", out var desc) ? desc.GetString() ?? "" : "",
                            UpdatedAt = item.TryGetProperty("updatedAt", out var updated) ? updated.GetDateTime() : DateTime.UtcNow,
                            Config = item.GetProperty("config")
                        });
                    }
                }

                ApplyFilters();
            }
            else
            {
                _errorMessage = $"Failed to load policies: {response.StatusCode}";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error loading policies: {ex.Message}";
            Logger.LogError(ex, "Error loading policies");
        }
        finally
        {
            _loading = false;
        }
    }

    private void ApplyFilters()
    {
        if (_policies == null) return;

        _filteredPolicies = _policies.Where(p =>
            (string.IsNullOrWhiteSpace(_filterType) || p.Type.Equals(_filterType, StringComparison.OrdinalIgnoreCase)) &&
            (string.IsNullOrWhiteSpace(_filterMode) || p.Mode.Equals(_filterMode, StringComparison.OrdinalIgnoreCase))
        ).ToList();
    }

    private void ClearFilters()
    {
        _filterType = "";
        _filterMode = "";
        ApplyFilters();
    }

    private async Task ShowCreateDialog()
    {
        _editingPolicy = null;
        var dialogModel = new PolicyDialogModel { Mode = "Shadow", Type = "Cors" };

        var parameters = new DialogParameters 
        { 
            ["Model"] = dialogModel,
            ["IsEdit"] = false
        };

        var dialog = await DialogService.ShowAsync<PolicyEditDialog>("Create Policy", parameters, 
            new DialogOptions { MaxWidth = MaxWidth.Large, FullWidth = true });
        var result = await dialog.Result;

        if (result != null && !result.Canceled && result.Data is PolicyDialogModel savedModel)
        {
            await SavePolicy(savedModel);
        }
    }

    private async Task ShowEditDialog(PolicyViewModel policy)
    {
        _editingPolicy = policy;
        var dialogModel = new PolicyDialogModel
        {
            Id = policy.Id,
            Type = policy.Type,
            Mode = policy.Mode,
            Description = policy.Description,
            ConfigJson = JsonSerializer.Serialize(policy.Config, new JsonSerializerOptions { WriteIndented = true })
        };

        var parameters = new DialogParameters 
        { 
            ["Model"] = dialogModel,
            ["IsEdit"] = true
        };

        var dialog = await DialogService.ShowAsync<PolicyEditDialog>("Edit Policy", parameters,
            new DialogOptions { MaxWidth = MaxWidth.Large, FullWidth = true });
        var result = await dialog.Result;

        if (result != null && !result.Canceled && result.Data is PolicyDialogModel savedModel)
        {
            await SavePolicy(savedModel);
        }
    }

    private async Task SavePolicy(PolicyDialogModel dialogPolicy)
    {
        _saving = true;
        _errorMessage = null;
        _successMessage = null;

        try
        {
            // Validate
            if (string.IsNullOrWhiteSpace(dialogPolicy.Id))
            {
                _errorMessage = "Policy ID is required.";
                return;
            }

            JsonElement configJson;
            try
            {
                configJson = JsonSerializer.Deserialize<JsonElement>(dialogPolicy.ConfigJson ?? "{}");
            }
            catch
            {
                _errorMessage = "Invalid JSON in configuration field.";
                return;
            }

            var payload = new
            {
                id = dialogPolicy.Id,
                type = dialogPolicy.Type,
                mode = dialogPolicy.Mode,
                description = dialogPolicy.Description,
                config = configJson
            };

            var client = HttpClientFactory.CreateClient("Gateway");
            var response = await client.PostAsJsonAsync("/admin/api/policies", payload);

            if (response.IsSuccessStatusCode)
            {
                _successMessage = $"Policy '{dialogPolicy.Id}' saved successfully.";
                await LoadPolicies();
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                _errorMessage = $"Failed to save policy: {response.StatusCode} - {error}";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error saving policy: {ex.Message}";
            Logger.LogError(ex, "Error saving policy");
        }
        finally
        {
            _saving = false;
        }
    }

    private async Task ShowDeleteConfirm(PolicyViewModel policy)
    {
        _deletingPolicy = policy;

        var parameters = new DialogParameters
        {
            ["Policy"] = policy
        };

        var dialog = await DialogService.ShowAsync<PolicyDeleteDialog>("Confirm Delete", parameters);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
            await ConfirmDelete();
        }
    }

    private async Task ConfirmDelete()
    {
        if (_deletingPolicy == null) return;

        _deleting = true;
        _errorMessage = null;
        _successMessage = null;

        try
        {
            var client = HttpClientFactory.CreateClient("Gateway");
            var response = await client.DeleteAsync($"/admin/api/policies/{_deletingPolicy.Id}");

            if (response.IsSuccessStatusCode || response.StatusCode == System.Net.HttpStatusCode.NoContent)
            {
                _successMessage = $"Policy '{_deletingPolicy.Id}' deleted successfully.";
                _deletingPolicy = null;
                await LoadPolicies();
            }
            else
            {
                _errorMessage = $"Failed to delete policy: {response.StatusCode}";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error deleting policy: {ex.Message}";
            Logger.LogError(ex, "Error deleting policy");
        }
        finally
        {
            _deleting = false;
        }
    }

    private Color GetTypeColor(string type) => type switch
    {
        "Cors" => Color.Primary,
        "IpAllow" => Color.Success,
        "IpDeny" => Color.Error,
        _ => Color.Default
    };

    private Color GetModeColor(string mode) => mode switch
    {
        "Shadow" => Color.Default,
        "AuditOnly" => Color.Warning,
        "Enforce" => Color.Error,
        _ => Color.Default
    };

    public class PolicyViewModel
    {
        public string Id { get; set; } = "";
        public string Type { get; set; } = "";
        public string Mode { get; set; } = "";
        public string Description { get; set; } = "";
        public DateTime UpdatedAt { get; set; }
        public JsonElement Config { get; set; }
    }
public class PolicyDialogModel
    {
        public string Id { get; set; } = "";
        public string Type { get; set; } = "Cors";
        public string Mode { get; set; } = "Shadow";
        public string Description { get; set; } = "";
        public string ConfigJson { get; set; } = "{}";
    }
}