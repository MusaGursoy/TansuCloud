@page "/admin/security"
@layout TansuCloud.Dashboard.Pages.Admin.AdminLayout
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Policy = "AdminOnly")]
@inject HttpClient Http
@using MudBlazor

<PageTitle>Security Events | TansuCloud Admin</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="py-4">
    <MudText Typo="Typo.h4" Class="mb-2">Security Events</MudText>
    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">
        Recent security-related events from the Identity service (last 100 events).
    </MudText>

    @if (error is not null)
    {
        <MudAlert Severity="Severity.Error" Variant="Variant.Filled" Class="mb-4">
            @error
        </MudAlert>
    }
    else if (events is null)
    {
        <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" Class="my-8" />
    }
    else if (events.Any())
    {
        <MudCard Elevation="2">
            <MudCardContent Class="pa-0">
                <MudTable Items="@events" Hover="true" Striped="true" Dense="true">
                    <HeaderContent>
                        <MudTh>ID</MudTh>
                        <MudTh>Type</MudTh>
                        <MudTh>User ID</MudTh>
                        <MudTh>Tenant ID</MudTh>
                        <MudTh>Actor ID</MudTh>
                        <MudTh>Created At</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="ID">
                            <MudText Typo="Typo.body2">@context.id</MudText>
                        </MudTd>
                        <MudTd DataLabel="Type">
                            <MudChip T="string" Size="Size.Small" Color="@GetEventTypeColor(context.type)">
                                @context.type
                            </MudChip>
                        </MudTd>
                        <MudTd DataLabel="User ID">
                            <MudText Typo="Typo.body2">@(context.userId ?? "-")</MudText>
                        </MudTd>
                        <MudTd DataLabel="Tenant ID">
                            <MudText Typo="Typo.body2">@(context.tenantId ?? "-")</MudText>
                        </MudTd>
                        <MudTd DataLabel="Actor ID">
                            <MudText Typo="Typo.body2">@(context.actorId ?? "-")</MudText>
                        </MudTd>
                        <MudTd DataLabel="Created At">
                            <MudText Typo="Typo.body2">@context.createdAt.ToString("yyyy-MM-dd HH:mm:ss")</MudText>
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            </MudCardContent>
        </MudCard>
    }
    else
    {
        <MudAlert Severity="Severity.Info" Variant="Variant.Outlined">
            No security events found.
        </MudAlert>
    }
</MudContainer>

@code {
    private List<SecEvent>? events;
    private string? error;
    private sealed record SecEvent(long id, string type, string? userId, string? tenantId, string? actorId, DateTimeOffset createdAt);

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Assumes gateway route /identity proxied
            var data = await System.Net.Http.Json.HttpClientJsonExtensions.GetFromJsonAsync<List<SecEvent>>(Http, 
                "/identity/admin/security/events?take=100");
            events = data ?? new List<SecEvent>();
        }
        catch (Exception ex)
        {
            error = $"Failed to load security events: {ex.Message}";
        }
    } // End of Method OnInitializedAsync

    private Color GetEventTypeColor(string eventType)
    {
        return eventType.ToLowerInvariant() switch
        {
            var e when e.Contains("failed") || e.Contains("blocked") || e.Contains("denied") => Color.Error,
            var e when e.Contains("lockout") || e.Contains("disabled") || e.Contains("warning") => Color.Warning,
            var e when e.Contains("success") || e.Contains("login") || e.Contains("signin") => Color.Success,
            _ => Color.Default
        };
    } // End of Method GetEventTypeColor
} // End of Class SecurityEvents
