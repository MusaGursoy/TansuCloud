@page "/admin/audit"
@layout TansuCloud.Dashboard.Pages.Admin.AdminLayout
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Policy = "AdminOnly")]
@using MudBlazor
@implements IDisposable

<PageTitle>Audit Log | TansuCloud Admin</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="py-4">
    <MudText Typo="Typo.h4" Class="mb-2">Audit Log</MudText>
    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">
        Query and export audit entries from the Database service with filtering and detail inspection.
    </MudText>

    <!-- Filters Card -->
    <MudCard Elevation="2" Class="mb-4">
        <MudCardHeader>
            <CardHeaderContent>
                <MudText Typo="Typo.h6">Filters</MudText>
            </CardHeaderContent>
            <CardHeaderActions>
                <MudButton Variant="Variant.Outlined" 
                           Color="Color.Default" 
                           Size="Size.Small"
                           StartIcon="@Icons.Material.Filled.RestartAlt"
                           OnClick="ResetFilters">
                    Reset
                </MudButton>
            </CardHeaderActions>
        </MudCardHeader>
        <MudCardContent>
            <MudGrid Spacing="2">
                <MudItem xs="12" sm="6" md="3">
                    <MudTextField T="DateTime"
                                  @bind-Value="startLocal"
                                  Label="Start (UTC)"
                                  InputType="InputType.DateTimeLocal"
                                  Variant="Variant.Outlined"
                                  Margin="Margin.Dense" />
                </MudItem>
                <MudItem xs="12" sm="6" md="3">
                    <MudTextField T="DateTime"
                                  @bind-Value="endLocal"
                                  Label="End (UTC)"
                                  InputType="InputType.DateTimeLocal"
                                  Variant="Variant.Outlined"
                                  Margin="Margin.Dense" />
                </MudItem>
                <MudItem xs="12" sm="6" md="3">
                    <MudTextField T="string"
                                  @bind-Value="tenantId"
                                  Label="Tenant"
                                  Variant="Variant.Outlined"
                                  Margin="Margin.Dense"
                                  Clearable="true" />
                </MudItem>
                <MudItem xs="12" sm="6" md="3">
                    <MudTextField T="string"
                                  @bind-Value="subject"
                                  Label="Subject"
                                  Variant="Variant.Outlined"
                                  Margin="Margin.Dense"
                                  Clearable="true" />
                </MudItem>
                <MudItem xs="12" sm="6" md="3">
                    <MudTextField T="string"
                                  @bind-Value="category"
                                  Label="Category"
                                  Variant="Variant.Outlined"
                                  Margin="Margin.Dense"
                                  Clearable="true" />
                </MudItem>
                <MudItem xs="12" sm="6" md="3">
                    <MudTextField T="string"
                                  @bind-Value="action"
                                  Label="Action"
                                  Variant="Variant.Outlined"
                                  Margin="Margin.Dense"
                                  Clearable="true" />
                </MudItem>
                <MudItem xs="12" sm="6" md="3">
                    <MudTextField T="string"
                                  @bind-Value="service"
                                  Label="Service"
                                  Variant="Variant.Outlined"
                                  Margin="Margin.Dense"
                                  Clearable="true" />
                </MudItem>
                <MudItem xs="12" sm="6" md="3">
                    <MudTextField T="string"
                                  @bind-Value="outcome"
                                  Label="Outcome"
                                  Variant="Variant.Outlined"
                                  Margin="Margin.Dense"
                                  Clearable="true" />
                </MudItem>
                <MudItem xs="12" sm="6" md="3">
                    <MudTextField T="string"
                                  @bind-Value="correlationId"
                                  Label="Correlation ID"
                                  Variant="Variant.Outlined"
                                  Margin="Margin.Dense"
                                  Clearable="true" />
                </MudItem>
                <MudItem xs="12" sm="6" md="3" Class="d-flex align-end">
                    <MudCheckBox T="bool" @bind-Value="impersonationOnly" Label="Impersonation only" Color="Color.Primary" />
                </MudItem>
                <MudItem xs="12" sm="6" md="3" Class="d-flex align-end">
                    <MudButton Variant="Variant.Filled" 
                               Color="Color.Primary" 
                               StartIcon="@Icons.Material.Filled.Search"
                               OnClick="SearchAsync"
                               FullWidth="true">
                        Search
                    </MudButton>
                </MudItem>
            </MudGrid>
        </MudCardContent>
    </MudCard>

    <!-- Actions Bar -->
    <MudPaper Elevation="1" Class="pa-3 mb-4 d-flex justify-space-between align-center">
        <div>
            <MudButton Variant="Variant.Outlined" 
                       Color="Color.Secondary" 
                       StartIcon="@Icons.Material.Filled.ExpandMore"
                       OnClick="LoadMoreAsync" 
                       Disabled="@string.IsNullOrEmpty(nextPageToken)">
                Load More
            </MudButton>
            <MudText Typo="Typo.body2" Color="Color.Secondary" Inline="true" Class="ml-3">
                @items.Count item(s) loaded
            </MudText>
        </div>
        <div>
            <MudButton Variant="Variant.Outlined" 
                       Color="Color.Success" 
                       StartIcon="@Icons.Material.Filled.Download"
                       OnClick="ExportCsvAsync"
                       Class="mr-2">
                Export CSV
            </MudButton>
            <MudButton Variant="Variant.Outlined" 
                       Color="Color.Info" 
                       StartIcon="@Icons.Material.Filled.Download"
                       OnClick="ExportJsonAsync">
                Export JSON
            </MudButton>
        </div>
    </MudPaper>

    <!-- Error/Loading/Results -->
    @if (error is not null)
    {
        <MudAlert Severity="Severity.Error" Variant="Variant.Filled" Class="mb-4">
            @error
        </MudAlert>
    }
    else if (loading)
    {
        <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" Class="my-8" />
    }
    else if (items.Count == 0)
    {
        <MudAlert Severity="Severity.Info" Variant="Variant.Outlined">
            No audit entries found for the selected range.
        </MudAlert>
    }
    else
    {
        <MudGrid Spacing="3">
            <!-- Audit Table (Left) -->
            <MudItem xs="12" md="7">
                <MudCard Elevation="2">
                    <MudCardContent Class="pa-0">
                        <MudTable Items="@items" 
                                  Hover="true" 
                                  Dense="true" 
                                  Striped="true"
                                  SelectedItemChanged="@Select"
                                  T="AuditItem">
                            <HeaderContent>
                                <MudTh>Time (UTC)</MudTh>
                                <MudTh>Tenant</MudTh>
                                <MudTh>Subject</MudTh>
                                <MudTh>Category</MudTh>
                                <MudTh>Action</MudTh>
                                <MudTh>Service</MudTh>
                                <MudTh>Outcome</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd DataLabel="Time (UTC)">
                                    <MudText Typo="Typo.body2">@context.WhenUtc.ToString("u")</MudText>
                                </MudTd>
                                <MudTd DataLabel="Tenant">
                                    <MudText Typo="Typo.body2">@context.TenantId</MudText>
                                </MudTd>
                                <MudTd DataLabel="Subject">
                                    <MudText Typo="Typo.body2">@context.Subject</MudText>
                                </MudTd>
                                <MudTd DataLabel="Category">
                                    <MudChip T="string" Size="Size.Small" Color="Color.Default">@context.Category</MudChip>
                                </MudTd>
                                <MudTd DataLabel="Action">
                                    <MudText Typo="Typo.body2">@context.Action</MudText>
                                </MudTd>
                                <MudTd DataLabel="Service">
                                    <MudText Typo="Typo.body2">@context.Service</MudText>
                                </MudTd>
                                <MudTd DataLabel="Outcome">
                                    <MudChip T="string" 
                                             Size="Size.Small" 
                                             Color="@GetOutcomeColor(context.Outcome)">
                                        @(context.Outcome ?? "-")
                                    </MudChip>
                                </MudTd>
                            </RowTemplate>
                        </MudTable>
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <!-- Detail Panel (Right) -->
            <MudItem xs="12" md="5">
                @if (selected is null)
                {
                    <MudPaper Elevation="2" Class="pa-8 text-center">
                        <MudIcon Icon="@Icons.Material.Filled.TouchApp" Size="Size.Large" Color="Color.Secondary" Class="mb-2" />
                        <MudText Typo="Typo.body1" Color="Color.Secondary">
                            Select a row to see details
                        </MudText>
                    </MudPaper>
                }
                else
                {
                    <MudCard Elevation="2">
                        <MudCardHeader>
                            <CardHeaderContent>
                                <MudText Typo="Typo.h6">@selected.Category / @selected.Action</MudText>
                            </CardHeaderContent>
                        </MudCardHeader>
                        <MudCardContent>
                            <MudList T="string" Dense="true" DisablePadding="true">
                                <MudListItem T="string">
                                    <MudText Typo="Typo.body2"><strong>When:</strong> @selected.WhenUtc.ToString("u")</MudText>
                                </MudListItem>
                                <MudListItem T="string">
                                    <MudText Typo="Typo.body2"><strong>Tenant:</strong> @selected.TenantId</MudText>
                                </MudListItem>
                                <MudListItem T="string">
                                    <MudText Typo="Typo.body2"><strong>Subject:</strong> @selected.Subject</MudText>
                                </MudListItem>
                                <MudListItem T="string">
                                    <MudText Typo="Typo.body2"><strong>Service:</strong> @selected.Service (@selected.Environment @selected.Version)</MudText>
                                </MudListItem>
                                <MudListItem T="string">
                                    <MudText Typo="Typo.body2"><strong>Outcome:</strong> @(selected.Outcome ?? "") (@(selected.ReasonCode ?? ""))</MudText>
                                </MudListItem>
                                <MudListItem T="string">
                                    <MudText Typo="Typo.body2"><strong>Route:</strong> @selected.RouteTemplate</MudText>
                                </MudListItem>
                                <MudListItem T="string">
                                    <MudText Typo="Typo.body2"><strong>CorrelationId:</strong> @selected.CorrelationId</MudText>
                                </MudListItem>
                                <MudListItem T="string">
                                    <MudText Typo="Typo.body2"><strong>Trace:</strong> @selected.TraceId / @selected.SpanId</MudText>
                                </MudListItem>
                                <MudListItem T="string">
                                    <MudText Typo="Typo.body2"><strong>Client:</strong> @selected.ClientIpHash; @selected.UserAgent</MudText>
                                </MudListItem>
                                <MudListItem T="string">
                                    <MudText Typo="Typo.body2"><strong>ImpersonatedBy:</strong> @(selected.ImpersonatedBy ?? "-")</MudText>
                                </MudListItem>
                            </MudList>

                            <MudDivider Class="my-3" />

                            <MudText Typo="Typo.subtitle2" Class="mb-2"><strong>Details:</strong></MudText>
                            <MudPaper Elevation="0" Class="pa-2 mud-background-gray" Style="white-space:pre-wrap; font-family: monospace; font-size: 0.875rem; max-height: 300px; overflow-y: auto;">
                                @detailsText
                            </MudPaper>
                        </MudCardContent>
                        <MudCardActions>
                            <MudButton Variant="Variant.Outlined" 
                                       Color="Color.Secondary" 
                                       StartIcon="@Icons.Material.Filled.OpenInNew"
                                       Href="@_sigNozBaseUrl" 
                                       Target="_blank">
                                Open SigNoz
                            </MudButton>
                        </MudCardActions>
                    </MudCard>
                }
            </MudItem>
        </MudGrid>
    }
</MudContainer>

@code {
    private List<AuditItem> items = new();
    private AuditItem? selected;
    private string? detailsText;
    private string? nextPageToken;
    private bool loading;
    private string? error;

    private DateTimeOffset startUtc = DateTimeOffset.UtcNow.AddHours(-1);
    private DateTimeOffset endUtc = DateTimeOffset.UtcNow;
    private string? tenantId;
    private string? subject;
    private string? category;
    private string? action;
    private string? service;
    private string? outcome;
    private string? correlationId;
    private bool impersonationOnly;

    // datetime-local binding helpers (UTC)
    private DateTime startLocal
    {
        get => startUtc.UtcDateTime;
        set => startUtc = DateTime.SpecifyKind(value, DateTimeKind.Utc);
    }
    private DateTime endLocal
    {
        get => endUtc.UtcDateTime;
        set => endUtc = DateTime.SpecifyKind(value, DateTimeKind.Utc);
    }

    [Inject] private HttpClient Http { get; set; } = default!;
    [Inject] private TansuCloud.Dashboard.Observability.SigNoz.SigNozMetricsCatalog Catalog { get; set; } = default!;
    [Inject] private Microsoft.Extensions.Options.IOptionsMonitor<TansuCloud.Dashboard.Observability.SigNoz.SigNozOptions> OptionsMonitor { get; set; } = default!;
    [Inject] private Microsoft.JSInterop.IJSRuntime JS { get; set; } = default!;

    private string _sigNozBaseUrl = string.Empty;
    private IDisposable? _optionsReload;

    protected override void OnInitialized()
    {
        _sigNozBaseUrl = Catalog.CreateCatalog().BaseUrl;
        _optionsReload = OptionsMonitor.OnChange((_, _) =>
        {
            _sigNozBaseUrl = Catalog.CreateCatalog().BaseUrl;
            _ = InvokeAsync(StateHasChanged);
        });
    } // End of Method OnInitialized

    protected override async Task OnInitializedAsync()
    {
        await SearchAsync();
    } // End of Method OnInitializedAsync

    private async Task SearchAsync()
    {
        try
        {
            loading = true; error = null; items.Clear(); nextPageToken = null; selected = null; detailsText = null;
            await LoadPageAsync();
        }
        finally { loading = false; }
    } // End of Method SearchAsync

    private async Task LoadMoreAsync()
    {
        await LoadPageAsync();
    } // End of Method LoadMoreAsync

    private async Task LoadPageAsync()
    {
        var url = new System.Text.StringBuilder();
        url.Append($"/db/api/audit?startUtc={Uri.EscapeDataString(startUtc.ToString("o"))}&endUtc={Uri.EscapeDataString(endUtc.ToString("o"))}&pageSize=100");
        if (!string.IsNullOrWhiteSpace(tenantId)) url.Append($"&tenantId={Uri.EscapeDataString(tenantId)}");
        if (!string.IsNullOrWhiteSpace(subject)) url.Append($"&subject={Uri.EscapeDataString(subject)}");
        if (!string.IsNullOrWhiteSpace(category)) url.Append($"&category={Uri.EscapeDataString(category)}");
        if (!string.IsNullOrWhiteSpace(action)) url.Append($"&action={Uri.EscapeDataString(action)}");
        if (!string.IsNullOrWhiteSpace(service)) url.Append($"&service={Uri.EscapeDataString(service)}");
        if (!string.IsNullOrWhiteSpace(outcome)) url.Append($"&outcome={Uri.EscapeDataString(outcome)}");
        if (!string.IsNullOrWhiteSpace(correlationId)) url.Append($"&correlationId={Uri.EscapeDataString(correlationId)}");
        if (impersonationOnly) url.Append("&impersonationOnly=true");
        if (!string.IsNullOrWhiteSpace(nextPageToken)) url.Append($"&pageToken={Uri.EscapeDataString(nextPageToken)}");

        try
        {
            var result = await Http.GetFromJsonAsync<QueryResult>(url.ToString());
            if (result is not null)
            {
                items.AddRange(result.Items);
                nextPageToken = result.NextPageToken;
            }
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
        StateHasChanged();
    } // End of Method LoadPageAsync

    private async Task ExportCsvAsync()
    {
        var url = BuildExportUrl("csv");
        await JS.InvokeVoidAsync("open", url, "_blank");
    } // End of Method ExportCsvAsync

    private async Task ExportJsonAsync()
    {
        var url = BuildExportUrl("json");
        await JS.InvokeVoidAsync("open", url, "_blank");
    } // End of Method ExportJsonAsync

    private string BuildExportUrl(string kind)
    {
        var url = new System.Text.StringBuilder();
        url.Append($"/db/api/audit/export/{kind}?startUtc={Uri.EscapeDataString(startUtc.ToString("o"))}&endUtc={Uri.EscapeDataString(endUtc.ToString("o"))}");
        if (!string.IsNullOrWhiteSpace(tenantId)) url.Append($"&tenantId={Uri.EscapeDataString(tenantId)}");
        if (!string.IsNullOrWhiteSpace(subject)) url.Append($"&subject={Uri.EscapeDataString(subject)}");
        if (!string.IsNullOrWhiteSpace(category)) url.Append($"&category={Uri.EscapeDataString(category)}");
        if (!string.IsNullOrWhiteSpace(action)) url.Append($"&action={Uri.EscapeDataString(action)}");
        if (!string.IsNullOrWhiteSpace(service)) url.Append($"&service={Uri.EscapeDataString(service)}");
        if (!string.IsNullOrWhiteSpace(outcome)) url.Append($"&outcome={Uri.EscapeDataString(outcome)}");
        if (!string.IsNullOrWhiteSpace(correlationId)) url.Append($"&correlationId={Uri.EscapeDataString(correlationId)}");
        if (impersonationOnly) url.Append("&impersonationOnly=true");
        return url.ToString();
    } // End of Method BuildExportUrl

    private void Select(AuditItem it)
    {
        selected = it;
        detailsText = it.Details?.RootElement.GetRawText() ?? "(no details)";
    } // End of Method Select

    private void ResetFilters()
    {
        startUtc = DateTimeOffset.UtcNow.AddHours(-1);
        endUtc = DateTimeOffset.UtcNow;
        tenantId = subject = category = action = service = outcome = correlationId = null;
        impersonationOnly = false;
        _ = SearchAsync();
    } // End of Method ResetFilters

    private Color GetOutcomeColor(string? outcome)
    {
        if (string.IsNullOrWhiteSpace(outcome)) return Color.Default;
        
        return outcome.ToLowerInvariant() switch
        {
            var o when o.Contains("success") => Color.Success,
            var o when o.Contains("fail") || o.Contains("error") => Color.Error,
            var o when o.Contains("warn") => Color.Warning,
            _ => Color.Default
        };
    } // End of Method GetOutcomeColor

    public void Dispose()
    {
        _optionsReload?.Dispose();
    } // End of Method Dispose

    private sealed class QueryResult
    {
        public List<AuditItem> Items { get; set; } = new();
        public string? NextPageToken { get; set; }
    } // End of Class QueryResult

    private sealed class AuditItem
    {
        public Guid Id { get; set; }
        public DateTimeOffset WhenUtc { get; set; }
        public string Service { get; set; } = string.Empty;
        public string Environment { get; set; } = string.Empty;
        public string Version { get; set; } = string.Empty;
        public string TenantId { get; set; } = string.Empty;
        public string Subject { get; set; } = string.Empty;
        public string Action { get; set; } = string.Empty;
        public string Category { get; set; } = string.Empty;
        public string RouteTemplate { get; set; } = string.Empty;
        public string CorrelationId { get; set; } = string.Empty;
        public string TraceId { get; set; } = string.Empty;
        public string SpanId { get; set; } = string.Empty;
        public string? ClientIpHash { get; set; }
        public string? UserAgent { get; set; }
        public string? Outcome { get; set; }
        public string? ReasonCode { get; set; }
        public System.Text.Json.JsonDocument? Details { get; set; }
        public string? ImpersonatedBy { get; set; }
        public string? SourceHost { get; set; }
    } // End of Class AuditItem
} // End of Class Audit
