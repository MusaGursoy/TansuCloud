@page "/admin/observability"
@layout TansuCloud.Dashboard.Pages.Admin.AdminLayout
@using MudBlazor
@using TansuCloud.Dashboard.Observability.Prometheus
@using TansuCloud.Dashboard.Services
@inject IPrometheusQueryService PrometheusService
@inject IGrafanaEmbedService GrafanaService
@inject NavigationManager Navigation
@inject ILogger<ObservabilityOverview> Logger
@inject ISnackbar Snackbar
@attribute [Authorize(Policy="AdminOnly")]

<PageTitle>Observability Dashboard - TansuCloud Admin</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-4 mb-4">
    <MudText Typo="Typo.h4" Class="mb-2">Observability Dashboard</MudText>
    <MudText Typo="Typo.body1" Class="mb-4">
        Real-time service health, metrics, and error tracking powered by Prometheus (Task 47 Phase 1).
    </MudText>

    @if (_loading)
    {
        <MudCard Elevation="1" Class="pa-4 text-center">
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
            <MudText Typo="Typo.body1" Class="mt-2">Loading observability data...</MudText>
        </MudCard>
    }
    else
    {
        <!-- Service Status Cards (Application Services Only) -->
        <MudGrid Class="mb-4">
            @if (_services.Any(s => s.ServiceName.StartsWith("tansu.")))
            {
                @foreach (var service in _services.Where(s => s.ServiceName.StartsWith("tansu.")).Take(6))
                {
                    <MudItem xs="12" sm="6" md="4" lg="2">
                        <MudCard Elevation="2">
                            <MudCardContent>
                                <MudText Typo="Typo.subtitle2" Class="mb-2">@service.ServiceName</MudText>
                                <MudChip T="string" Size="Size.Small" Color="@GetHealthColor(service)" Variant="Variant.Filled">
                                    @GetHealthStatus(service)
                                </MudChip>
                                <MudText Typo="Typo.caption" Class="mt-2">Error Rate: @service.ErrorRate.ToString("P2")</MudText>
                                <MudText Typo="Typo.caption">Call Rate: @service.CallRate.ToString("F1")/s</MudText>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                }
            }
            else
            {
                <MudItem xs="12">
                    <MudAlert Severity="Severity.Info">No service data available. Services will appear here once trace data is collected.</MudAlert>
                </MudItem>
            }
        </MudGrid>

        <!-- Service Topology -->
        @if (_topology != null && _topology.Nodes.Any())
        {
            <MudCard Elevation="2" Class="mb-4">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">Service Topology</MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    <MudSimpleTable Dense="true" Hover="true">
                        <thead>
                            <tr>
                                <th>Service</th>
                                <th>Type</th>
                                <th>Call Rate</th>
                                <th>Error Rate</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var node in _topology.Nodes.Take(10))
                            {
                                <tr>
                                    <td><strong>@node.ServiceName</strong></td>
                                    <td>@node.ServiceType</td>
                                    <td>@node.CallRate.ToString("F1")/s</td>
                                    <td>
                                        <MudChip T="string" Size="Size.Small" Color="@(node.ErrorRate > 0.05 ? Color.Error : Color.Success)">
                                            @node.ErrorRate.ToString("P2")
                                        </MudChip>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </MudSimpleTable>
                </MudCardContent>
            </MudCard>
        }

        <!-- Recent Errors -->
        @if (_recentErrors != null && _recentErrors.Errors.Any())
        {
            <MudCard Elevation="2" Class="mb-4">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">Recent Errors (Last Hour)</MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    <MudTable Items="@_recentErrors.Errors.Take(10)" Hover="true" Dense="true">
                        <HeaderContent>
                            <MudTh>Timestamp</MudTh>
                            <MudTh>Service</MudTh>
                            <MudTh>Error Message</MudTh>
                            <MudTh>Trace ID</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd>@context.Timestamp.ToString("HH:mm:ss")</MudTd>
                            <MudTd>@context.ServiceName</MudTd>
                            <MudTd>
                                <MudText Typo="Typo.body2" Style="max-width: 400px; overflow: hidden; text-overflow: ellipsis;">
                                    @context.ErrorMessage
                                </MudText>
                            </MudTd>
                            <MudTd>
                                <MudChip T="string" Size="Size.Small" Icon="@Icons.Material.Filled.Link" 
                                         OnClick="@(() => ViewTrace(context.TraceId))"
                                         Color="Color.Info" Variant="Variant.Text">
                                    @context.TraceId.Substring(0, Math.Min(8, context.TraceId.Length))
                                </MudChip>
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                </MudCardContent>
            </MudCard>
        }

        <!-- Quick Actions -->
        <MudGrid>
            <MudItem xs="12" sm="6" md="4">
                <MudButton Variant="Variant.Filled" 
                          Color="Color.Primary" 
                          FullWidth="true"
                          StartIcon="@Icons.Material.Filled.Timeline"
                          OnClick="@(() => Navigation.NavigateTo("/admin/observability/traces"))">
                    View All Traces
                </MudButton>
            </MudItem>
            <MudItem xs="12" sm="6" md="4">
                <MudButton Variant="Variant.Filled" 
                          Color="Color.Secondary" 
                          FullWidth="true"
                          StartIcon="@Icons.Material.Filled.Description"
                          OnClick="@(() => Navigation.NavigateTo("/admin/observability/logs"))">
                    View All Logs
                </MudButton>
            </MudItem>
            <MudItem xs="12" sm="6" md="4">
                <MudButton Variant="Variant.Outlined" 
                          Color="Color.Default" 
                          FullWidth="true"
                          StartIcon="@Icons.Material.Filled.Settings"
                          OnClick="@(() => Navigation.NavigateTo("/admin/observability/config"))">
                    Configure
                </MudButton>
            </MudItem>
        </MudGrid>

        <!-- Grafana Dashboard Embedding (Task 47 Phase 4) -->
        @if (GrafanaService.IsGrafanaAvailable)
        {
            <MudDivider Class="my-6" />
            
            <MudText Typo="Typo.h5" Class="mb-2">
                <MudIcon Icon="@Icons.Material.Filled.Dashboard" Class="mr-2" />
                Advanced Dashboards (Grafana)
            </MudText>
            <MudText Typo="Typo.body2" Class="mb-4">
                Interactive charts powered by Prometheus, Tempo, and Loki. Auto-refreshes every 30 seconds.
            </MudText>

            <!-- Time Range Selector -->
            <MudButtonGroup Color="Color.Primary" Variant="Variant.Outlined" Size="Size.Small" Class="mb-4">
                <MudButton OnClick="@(() => SetTimeRange("now-15m"))">15m</MudButton>
                <MudButton OnClick="@(() => SetTimeRange("now-1h"))">1h</MudButton>
                <MudButton OnClick="@(() => SetTimeRange("now-6h"))">6h</MudButton>
                <MudButton OnClick="@(() => SetTimeRange("now-24h"))">24h</MudButton>
            </MudButtonGroup>

            <!-- TansuCloud Overview Dashboard -->
            <MudCard Elevation="2" Class="mb-4">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">TansuCloud Overview</MudText>
                        <MudText Typo="Typo.body2">Service health, request rates, and latency p95</MudText>
                    </CardHeaderContent>
                    <CardHeaderActions>
                        <MudIconButton Icon="@Icons.Material.Filled.Refresh" 
                                      Color="Color.Primary" 
                                      Size="Size.Small"
                                      OnClick="RefreshGrafana" />
                    </CardHeaderActions>
                </MudCardHeader>
                <MudCardContent Class="pa-0">
                    @if (!string.IsNullOrEmpty(_grafanaOverviewUrl))
                    {
                        <iframe src="@_grafanaOverviewUrl" 
                                style="width: 100%; height: 2400px; border: none;">
                        </iframe>
                    }
                    else
                    {
                        <div class="pa-4 text-center">
                            <MudText Typo="Typo.body2" Color="Color.Error">
                                Grafana dashboard unavailable. Check configuration.
                            </MudText>
                        </div>
                    }
                </MudCardContent>
            </MudCard>
        }
    }
</MudContainer>

@code {
    private bool _loading = true;
    private List<ServiceNode> _services = new();
    private ServiceTopologyResult? _topology;
    private RecentErrorsResult? _recentErrors;
    
    // Grafana embedding state (Task 47 Phase 4)
    private string? _grafanaOverviewUrl;
    private string _selectedTimeRange = "now-1h";

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
        UpdateGrafanaUrl();
    }

    private async Task LoadData()
    {
        _loading = true;
        Console.WriteLine("[OVERVIEW] LoadData() starting...");
        try
        {
            Console.WriteLine("[OVERVIEW] Calling GetServiceTopologyAsync...");
            // Load all dashboard data in parallel
            var topologyTask = PrometheusService.GetServiceTopologyAsync();
            var errorsTask = PrometheusService.GetRecentErrorsAsync(serviceName: null, timeRangeMinutes: 60, limit: 10);

            await Task.WhenAll(topologyTask, errorsTask);

            _topology = await topologyTask;
            _services = _topology?.Nodes.ToList() ?? new();
            Console.WriteLine($"[OVERVIEW] Got {_services.Count} services from topology");
            _recentErrors = await errorsTask;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[OVERVIEW] ERROR: {ex.Message}");
            Logger.LogError(ex, "Error loading observability dashboard data");
            Snackbar.Add("Failed to load observability data. Check Prometheus connection.", Severity.Error);
        }
        finally
        {
            Console.WriteLine("[OVERVIEW] LoadData() finished");
            _loading = false;
        }
    }

    private void UpdateGrafanaUrl()
    {
        if (!GrafanaService.IsGrafanaAvailable)
        {
            _grafanaOverviewUrl = null;
            return;
        }

        _grafanaOverviewUrl = GrafanaService.GetDashboardEmbedUrl(
            dashboardUid: "tansucloud-overview",
            theme: "light",
            timeRange: _selectedTimeRange);
        
        Logger.LogDebug("Updated Grafana URL: {Url}", _grafanaOverviewUrl);
    }

    private void SetTimeRange(string timeRange)
    {
        _selectedTimeRange = timeRange;
        UpdateGrafanaUrl();
        StateHasChanged();
    }

    private void RefreshGrafana()
    {
        UpdateGrafanaUrl();
        StateHasChanged();
        Snackbar.Add("Dashboard refreshed", Severity.Info);
    }

    private Color GetHealthColor(ServiceNode service)
    {
        if (service.ErrorRate > 0.05) return Color.Error;
        if (service.ErrorRate > 0.01) return Color.Warning;
        return Color.Success;
    }

    private string GetHealthStatus(ServiceNode service)
    {
        if (service.ErrorRate > 0.05) return "Degraded";
        if (service.ErrorRate > 0.01) return "Warning";
        return "Healthy";
    }

    private string FormatLatency(double latencyMs)
    {
        if (latencyMs < 1) return $"{latencyMs * 1000:F0}Âµs";
        if (latencyMs < 1000) return $"{latencyMs:F0}ms";
        return $"{latencyMs / 1000:F2}s";
    }

    private List<ServiceEdge> GetDependencies(string serviceName)
    {
        return _topology?.Edges.Where(e => e.SourceService == serviceName).ToList() ?? new();
    }

    private void ViewTrace(string traceId)
    {
        Navigation.NavigateTo($"/admin/observability/traces?traceId={traceId}");
    }
}

