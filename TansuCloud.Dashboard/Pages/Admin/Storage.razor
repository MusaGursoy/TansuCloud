@page "/admin/storage"
@layout TansuCloud.Dashboard.Pages.Admin.AdminLayout
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Policy = "AdminOnly")]
@using Microsoft.AspNetCore.Components.Forms
@inject HttpClient Http

<PageTitle>Storage Management | TansuCloud Admin</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-2">Storage Management</MudText>
    <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-4">
        Manage buckets, upload objects, and monitor storage usage.
    </MudText>

    <!-- Tenant ID Input -->
    <MudTextField T="string" @bind-Value="tenantId" Label="Tenant Id (X-Tansu-Tenant)" 
                  Placeholder="acme-dev" Variant="Variant.Outlined" 
                  HelperText="All storage calls include this tenant header."
                  Class="mb-4" Style="max-width: 600px;" />

    <!-- Usage Display -->
    @if (usage is not null)
    {
        <MudAlert Severity="Severity.Info" Class="mb-4" Style="max-width: 900px;">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <strong>Usage</strong> — Objects: @usage.objectCount / @(usage.maxObjectCount ?? 0), Bytes: @usage.totalBytes / @(usage.maxTotalBytes ?? 0)
                </div>
                <MudButton Variant="Variant.Outlined" Color="Color.Default" Size="Size.Small" 
                           OnClick="LoadUsageAsync" StartIcon="@Icons.Material.Filled.Refresh">
                    Refresh
                </MudButton>
            </div>
        </MudAlert>
    }

    <MudDivider Class="my-4" />

    <!-- Buckets Section -->
    <MudText Typo="Typo.h5" Class="mb-3">Buckets</MudText>
    
    <MudGrid Class="mb-3" Style="max-width: 900px;">
        <MudItem xs="12" sm="8">
            <MudTextField T="string" @bind-Value="newBucket" Label="New bucket name" 
                          Variant="Variant.Outlined" />
        </MudItem>
        <MudItem xs="12" sm="4" Class="d-flex align-items-end gap-2">
            <MudButton Variant="Variant.Filled" Color="Color.Primary" 
                       OnClick="CreateBucketAsync" StartIcon="@Icons.Material.Filled.CreateNewFolder">
                Create
            </MudButton>
            <MudButton Variant="Variant.Outlined" Color="Color.Default" 
                       OnClick="LoadBucketsAsync" StartIcon="@Icons.Material.Filled.Refresh">
                Refresh
            </MudButton>
        </MudItem>
    </MudGrid>

    @if (bucketError is not null)
    {
        <MudAlert Severity="Severity.Error" ShowCloseIcon="true" CloseIconClicked="@(() => bucketError = null)" Class="mb-3" Style="max-width: 900px;">
            @bucketError
        </MudAlert>
    }

    <MudTable T="string" Items="@buckets" Hover="true" Dense="true" Striped="true" 
              Style="max-width: 900px;" Class="mb-4" Elevation="2">
        <HeaderContent>
            <MudTh>Bucket</MudTh>
            <MudTh Style="text-align: right;">Actions</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Bucket">@context</MudTd>
            <MudTd DataLabel="Actions" Style="text-align: right;">
                <MudButton Variant="Variant.Outlined" Color="Color.Error" Size="Size.Small" 
                           OnClick="@(() => DeleteBucketAsync(context))" 
                           StartIcon="@Icons.Material.Filled.Delete">
                    Delete
                </MudButton>
            </MudTd>
        </RowTemplate>
        <NoRecordsContent>
            @if (buckets is null)
            {
                <MudText Typo="Typo.body2" Color="Color.Secondary">Load buckets…</MudText>
            }
            else
            {
                <MudText Typo="Typo.body2" Color="Color.Secondary">No buckets</MudText>
            }
        </NoRecordsContent>
    </MudTable>

    <MudDivider Class="my-4" />

    <!-- Objects Section -->
    <MudText Typo="Typo.h5" Class="mb-3">Objects (presigned upload + HEAD)</MudText>

    <MudGrid Style="max-width: 900px;">
        <MudItem xs="12" md="4">
            <MudTextField T="string" @bind-Value="objBucket" Label="Bucket" Variant="Variant.Outlined" />
        </MudItem>
        <MudItem xs="12" md="8">
            <MudTextField T="string" @bind-Value="objKey" Label="Key" Variant="Variant.Outlined" />
        </MudItem>

        <MudItem xs="12" md="6">
            <MudTextField T="string" @bind-Value="objPrefix" Label="Prefix (list objects)" Variant="Variant.Outlined" />
        </MudItem>
        <MudItem xs="12" md="6" Class="d-flex align-items-end gap-2">
            <MudButton Variant="Variant.Outlined" Color="Color.Default" 
                       OnClick="ListObjectsAsync" StartIcon="@Icons.Material.Filled.List">
                List objects
            </MudButton>
            <MudButton Variant="Variant.Outlined" Color="Color.Default" 
                       OnClick="@(() => { objItems = null; })" StartIcon="@Icons.Material.Filled.Clear">
                Clear list
            </MudButton>
        </MudItem>

        <MudItem xs="12" md="6">
            <MudFileUpload T="IBrowserFile" Accept="*" OnFilesChanged="HandleSelected" MaximumFileCount="1">
                <ActivatorContent>
                    <MudButton Variant="Variant.Outlined" Color="Color.Default" 
                               StartIcon="@Icons.Material.Filled.AttachFile" FullWidth="true">
                        @if (selectedFile is null)
                        {
                            <span>Select file to upload</span>
                        }
                        else
                        {
                            <span>@selectedFile.Name (@selectedFile.Size bytes)</span>
                        }
                    </MudButton>
                </ActivatorContent>
            </MudFileUpload>
            <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-1">
                Uses a presigned anonymous PUT with media-type enforcement.
            </MudText>
        </MudItem>

        <MudItem xs="12" md="3">
            <MudNumericField T="long?" @bind-Value="presignMaxBytes" Label="Max bytes (optional)" 
                             Min="0" Variant="Variant.Outlined" />
        </MudItem>

        <MudItem xs="12" md="3" Class="d-flex align-items-end">
            <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true" 
                       Disabled="@(!canUpload)" OnClick="UploadPresignedAsync" 
                       StartIcon="@Icons.Material.Filled.CloudUpload">
                Upload
            </MudButton>
        </MudItem>

        <MudItem xs="12">
            <MudButton Variant="Variant.Outlined" Color="Color.Default" 
                       OnClick="HeadAsync" StartIcon="@Icons.Material.Filled.Info">
                HEAD (metadata)
            </MudButton>
        </MudItem>

        @if (!string.IsNullOrEmpty(objStatus))
        {
            <MudItem xs="12">
                <MudPaper Elevation="1" Class="pa-3">
                    <pre style="margin: 0; white-space: pre-wrap;">@objStatus</pre>
                </MudPaper>
            </MudItem>
        }

        @if (!string.IsNullOrEmpty(objError))
        {
            <MudItem xs="12">
                <MudAlert Severity="Severity.Error" ShowCloseIcon="true" CloseIconClicked="@(() => objError = null)">
                    @objError
                </MudAlert>
            </MudItem>
        }

        @if (objItems is not null)
        {
            <MudItem xs="12">
                <MudTable T="ObjectItem" Items="@objItems" Hover="true" Dense="true" Striped="true" Elevation="2">
                    <HeaderContent>
                        <MudTh>Key</MudTh>
                        <MudTh>ETag</MudTh>
                        <MudTh>Length</MudTh>
                        <MudTh>Content-Type</MudTh>
                        <MudTh>Last Modified</MudTh>
                        <MudTh Style="text-align: right;">Actions</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Key">@context.Key</MudTd>
                        <MudTd DataLabel="ETag">
                            @if (!string.IsNullOrWhiteSpace(context.ETag))
                            {
                                <code>@context.ETag</code>
                            }
                        </MudTd>
                        <MudTd DataLabel="Length">@context.Length</MudTd>
                        <MudTd DataLabel="Content-Type">@context.ContentType</MudTd>
                        <MudTd DataLabel="Last Modified">@context.LastModified?.ToString("u")</MudTd>
                        <MudTd DataLabel="Actions" Style="text-align: right;">
                            <MudButton Variant="Variant.Outlined" Color="Color.Error" Size="Size.Small" 
                                       OnClick="@(() => DeleteObjectAsync(objBucket, context.Key))" 
                                       StartIcon="@Icons.Material.Filled.Delete">
                                Delete
                            </MudButton>
                        </MudTd>
                    </RowTemplate>
                    <NoRecordsContent>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">No objects</MudText>
                    </NoRecordsContent>
                </MudTable>
            </MudItem>
        }
    </MudGrid>
</MudContainer>

@code {
    private string tenantId = "acme-dev";
    private List<string>? buckets;
    private string? newBucket;
    private string? bucketError;

    private string objBucket = string.Empty;
    private string objKey = string.Empty;
    private string? objPrefix;
    private IBrowserFile? selectedFile;
    private long? presignMaxBytes;
    private string? objError;
    private string? objStatus;
    private UsageDto? usage;
    private List<ObjectItem>? objItems;

    private bool canUpload => !string.IsNullOrWhiteSpace(tenantId)
        && !string.IsNullOrWhiteSpace(objBucket)
        && !string.IsNullOrWhiteSpace(objKey)
        && selectedFile is not null;

    protected override async Task OnInitializedAsync()
    {
        await LoadUsageAsync();
        await LoadBucketsAsync();
    } // End of Method OnInitializedAsync

    private async Task LoadUsageAsync()
    {
        try
        {
            var req = new HttpRequestMessage(HttpMethod.Get, "/storage/api/usage");
            req.Headers.Add("X-Tansu-Tenant", tenantId);
            var resp = await Http.SendAsync(req);
            if (resp.IsSuccessStatusCode)
            {
                usage = await resp.Content.ReadFromJsonAsync<UsageDto>();
            }
        }
        catch { /* ignore */ }
    } // End of Method LoadUsageAsync

    private async Task LoadBucketsAsync()
    {
        bucketError = null;
        try
        {
            var req = new HttpRequestMessage(HttpMethod.Get, "/storage/api/buckets");
            req.Headers.Add("X-Tansu-Tenant", tenantId);
            var resp = await Http.SendAsync(req);
            if (!resp.IsSuccessStatusCode)
            {
                bucketError = $"List buckets failed: {(int)resp.StatusCode} {resp.ReasonPhrase}";
                buckets = new();
                return;
            }
            var list = await resp.Content.ReadFromJsonAsync<List<string>>();
            buckets = list ?? new();
        }
        catch (Exception ex)
        {
            bucketError = ex.Message;
            buckets = new();
        }
    } // End of Method LoadBucketsAsync

    private async Task CreateBucketAsync()
    {
        bucketError = null;
        if (string.IsNullOrWhiteSpace(newBucket)) return;
        try
        {
            var req = new HttpRequestMessage(HttpMethod.Put, $"/storage/api/buckets/{Uri.EscapeDataString(newBucket!)}");
            req.Headers.Add("X-Tansu-Tenant", tenantId);
            var resp = await Http.SendAsync(req);
            if (!resp.IsSuccessStatusCode)
            {
                bucketError = $"Create failed: {(int)resp.StatusCode} {resp.ReasonPhrase}";
            }
            else
            {
                newBucket = null;
                await LoadBucketsAsync();
            }
        }
        catch (Exception ex)
        {
            bucketError = ex.Message;
        }
    } // End of Method CreateBucketAsync

    private async Task DeleteBucketAsync(string bucket)
    {
        bucketError = null;
        try
        {
            var req = new HttpRequestMessage(HttpMethod.Delete, $"/storage/api/buckets/{Uri.EscapeDataString(bucket)}");
            req.Headers.Add("X-Tansu-Tenant", tenantId);
            var resp = await Http.SendAsync(req);
            if (!resp.IsSuccessStatusCode)
            {
                bucketError = $"Delete failed: {(int)resp.StatusCode} {resp.ReasonPhrase}";
            }
            await LoadBucketsAsync();
        }
        catch (Exception ex)
        {
            bucketError = ex.Message;
        }
    } // End of Method DeleteBucketAsync

    private void HandleSelected(InputFileChangeEventArgs e)
    {
        selectedFile = e.FileCount > 0 ? e.File : null;
    } // End of Method HandleSelected

    private async Task UploadPresignedAsync()
    {
        objError = null; objStatus = null;
        try
        {
            // Use previously selected file
            var file = selectedFile;
            if (file is null) { objError = "No file selected"; return; }

            var contentType = file.ContentType ?? "application/octet-stream";
            var create = new PresignReq
            {
                Method = "PUT",
                Bucket = objBucket,
                Key = objKey,
                MaxBytes = presignMaxBytes,
                ContentType = contentType,
                ExpirySeconds = 300
            };
            var preReq = new HttpRequestMessage(HttpMethod.Post, "/storage/api/presign");
            preReq.Headers.Add("X-Tansu-Tenant", tenantId);
            preReq.Content = JsonContent.Create(create);
            var preResp = await Http.SendAsync(preReq);
            if (!preResp.IsSuccessStatusCode)
            {
                objError = $"Presign failed: {(int)preResp.StatusCode} {preResp.ReasonPhrase}";
                return;
            }
            var presign = await preResp.Content.ReadFromJsonAsync<PresignResp>();
            if (presign is null) { objError = "No presign body"; return; }

            var absolute = new Uri(Http.BaseAddress!, presign.url);
            using var anon = new HttpClient();
            using var fs = file.OpenReadStream(long.MaxValue);
            using var put = new HttpRequestMessage(HttpMethod.Put, absolute);
            put.Headers.Add("X-Tansu-Tenant", tenantId);
            put.Content = new StreamContent(fs);
            put.Content.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue(contentType);
            var putResp = await anon.SendAsync(put);
            var body = await putResp.Content.ReadAsStringAsync();
            objStatus = $"PUT {(int)putResp.StatusCode} {putResp.ReasonPhrase}\n{body}";
            if (!putResp.IsSuccessStatusCode)
            {
                objError = objStatus;
            }
            else
            {
                await LoadUsageAsync();
                await ListObjectsAsync();
            }
        }
        catch (Exception ex)
        {
            objError = ex.Message;
        }
    } // End of Method UploadPresignedAsync

    private async Task HeadAsync()
    {
        objError = null; objStatus = null;
        try
        {
            var req = new HttpRequestMessage(HttpMethod.Head, $"/storage/api/objects/{Uri.EscapeDataString(objBucket)}/{Uri.EscapeDataString(objKey)}");
            req.Headers.Add("X-Tansu-Tenant", tenantId);
            var resp = await Http.SendAsync(req);
            objStatus = $"HEAD {(int)resp.StatusCode} {resp.ReasonPhrase}\nETag: {resp.Headers.ETag?.Tag}\nCT: {resp.Content.Headers.ContentType}\nLen: {resp.Content.Headers.ContentLength}";
            if (!resp.IsSuccessStatusCode)
            {
                objError = objStatus;
            }
        }
        catch (Exception ex)
        {
            objError = ex.Message;
        }
    } // End of Method HeadAsync

    private async Task ListObjectsAsync()
    {
        objError = null;
        objItems = null;
        try
        {
            if (string.IsNullOrWhiteSpace(objBucket))
            {
                objItems = new();
                return;
            }
            var url = $"/storage/api/objects?bucket={Uri.EscapeDataString(objBucket)}" +
                      (string.IsNullOrWhiteSpace(objPrefix) ? string.Empty : $"&prefix={Uri.EscapeDataString(objPrefix)}");
            var req = new HttpRequestMessage(HttpMethod.Get, url);
            req.Headers.Add("X-Tansu-Tenant", tenantId);
            var resp = await Http.SendAsync(req);
            if (!resp.IsSuccessStatusCode)
            {
                objError = $"List objects failed: {(int)resp.StatusCode} {resp.ReasonPhrase}";
                objItems = new();
                return;
            }
            var list = await resp.Content.ReadFromJsonAsync<List<ObjectItem>>();
            objItems = list ?? new();
        }
        catch (Exception ex)
        {
            objError = ex.Message;
            objItems = new();
        }
    } // End of Method ListObjectsAsync

    private async Task DeleteObjectAsync(string bucket, string key)
    {
        try
        {
            var req = new HttpRequestMessage(HttpMethod.Delete, $"/storage/api/objects/{Uri.EscapeDataString(bucket)}/{Uri.EscapeDataString(key)}");
            req.Headers.Add("X-Tansu-Tenant", tenantId);
            var resp = await Http.SendAsync(req);
            if (!resp.IsSuccessStatusCode)
            {
                objError = $"Delete object failed: {(int)resp.StatusCode} {resp.ReasonPhrase}";
            }
            await LoadUsageAsync();
            await ListObjectsAsync();
        }
        catch (Exception ex)
        {
            objError = ex.Message;
        }
    } // End of Method DeleteObjectAsync

    // DTOs
    private sealed class PresignReq
    {
        public string Method { get; set; } = "PUT";
        public string Bucket { get; set; } = string.Empty;
        public string Key { get; set; } = string.Empty;
        public int? ExpirySeconds { get; set; }
        public long? MaxBytes { get; set; }
        public string? ContentType { get; set; }
    } // End of Class PresignReq

    private sealed class PresignResp 
    { 
        public string url { get; set; } = string.Empty; 
        public long expires { get; set; } 
    } // End of Class PresignResp

    private sealed class UsageDto
    {
        public long totalBytes { get; set; }
        public int objectCount { get; set; }
        public long? maxTotalBytes { get; set; }
        public int? maxObjectCount { get; set; }
        public long? maxObjectSizeBytes { get; set; }
    } // End of Class UsageDto

    private sealed class ObjectItem
    {
        public string Key { get; set; } = string.Empty;
        public string? ETag { get; set; }
        public long Length { get; set; }
        public string? ContentType { get; set; }
        public DateTimeOffset? LastModified { get; set; }
    } // End of Class ObjectItem
} // End of Class Storage
