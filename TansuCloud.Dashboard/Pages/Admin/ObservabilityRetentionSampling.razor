@page "/admin/observability/retention-sampling"
@using System.Net.Http.Json
@using System.Text.Json
@attribute [Authorize(Policy = "AdminOnly")]
@layout TansuCloud.Dashboard.Pages.Admin.AdminLayout
@inject IHttpClientFactory HttpClientFactory
@inject ILogger<ObservabilityRetentionSampling> Logger
@inject ISnackbar Snackbar

<PageTitle>Observability Retention & Sampling | TansuCloud Admin</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-2">Observability Retention & Sampling</MudText>
    <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-4">
        Configure retention policies and sampling rates for Prometheus metrics, Tempo traces, and Loki logs.
    </MudText>

    @if (_loading)
    {
        <MudProgressCircular Indeterminate="true" />
    }
    else if (_settings is null || !_settings.Any())
    {
        <MudAlert Severity="Severity.Warning">No observability settings found.</MudAlert>
    }
    else
    {
        <MudGrid>
            @foreach (var setting in _settings.OrderBy(s => s.Component))
            {
                <MudItem xs="12" md="4">
                    <MudCard Elevation="2">
                        <MudCardHeader>
                            <CardHeaderContent>
                                <MudText Typo="Typo.h6">@GetComponentDisplayName(setting.Component)</MudText>
                            </CardHeaderContent>
                            <CardHeaderActions>
                                <MudSwitch @bind-Value="setting.Enabled" Color="Color.Success" 
                                          @onchange="@(() => UpdateSetting(setting))" />
                            </CardHeaderActions>
                        </MudCardHeader>
                        <MudCardContent>
                            <MudStack Spacing="3">
                                <MudNumericField @bind-Value="setting.RetentionDays" 
                                               Label="Retention (days)" 
                                               Min="1" Max="365" 
                                               Variant="Variant.Outlined"
                                               HelperText="Data older than this will be deleted" />
                                
                                <MudNumericField @bind-Value="setting.SamplingPercent" 
                                               Label="Sampling (%)" 
                                               Min="0" Max="100" 
                                               Variant="Variant.Outlined"
                                               HelperText="Percentage of data to collect" />
                                
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    Last updated: @setting.UpdatedAt?.ToString("g") by @setting.UpdatedBy
                                </MudText>
                            </MudStack>
                        </MudCardContent>
                        <MudCardActions>
                            <MudButton Color="Color.Primary" Variant="Variant.Filled" 
                                     OnClick="@(() => UpdateSetting(setting))" 
                                     StartIcon="@Icons.Material.Filled.Save">
                                Save
                            </MudButton>
                            <MudButton Color="Color.Default" Variant="Variant.Outlined" 
                                     OnClick="@(() => ReloadSettings())">
                                Reset
                            </MudButton>
                        </MudCardActions>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>

        <MudDivider Class="my-6" />

        <MudText Typo="Typo.h6" Class="mb-3">Current Configuration Summary</MudText>
        <MudSimpleTable Style="overflow-x: auto;">
            <thead>
                <tr>
                    <th>Component</th>
                    <th>Status</th>
                    <th>Retention</th>
                    <th>Sampling</th>
                    <th>Last Updated</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var setting in _settings.OrderBy(s => s.Component))
                {
                    <tr>
                        <td>@GetComponentDisplayName(setting.Component)</td>
                        <td>
                            @if (setting.Enabled)
                            {
                                <MudChip T="string" Color="Color.Success" Size="Size.Small">Enabled</MudChip>
                            }
                            else
                            {
                                <MudChip T="string" Color="Color.Default" Size="Size.Small">Disabled</MudChip>
                            }
                        </td>
                        <td>@setting.RetentionDays days</td>
                        <td>@setting.SamplingPercent%</td>
                        <td>@setting.UpdatedAt?.ToString("g")</td>
                    </tr>
                }
            </tbody>
        </MudSimpleTable>

        <MudAlert Severity="Severity.Info" Class="mt-4">
            <strong>Note:</strong> Changes to retention and sampling settings require the respective service (Prometheus/Tempo/Loki) to be restarted to take effect.
            Settings are automatically applied on service startup.
        </MudAlert>
    }
</MudContainer>

@code {
    private bool _loading = true;
    private List<ObservabilitySetting>? _settings;

    protected override async Task OnInitializedAsync()
    {
        await ReloadSettings();
    }

    private async Task ReloadSettings()
    {
        _loading = true;
        try
        {
            var client = HttpClientFactory.CreateClient("Gateway");
            _settings = await client.GetFromJsonAsync<List<ObservabilitySetting>>("/admin/api/observability/settings");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load observability settings");
            Snackbar.Add("Failed to load settings", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task UpdateSetting(ObservabilitySetting setting)
    {
        try
        {
            var client = HttpClientFactory.CreateClient("Gateway");
            var response = await client.PutAsJsonAsync($"/admin/api/observability/settings/{setting.Component}", new
            {
                retentionDays = setting.RetentionDays,
                samplingPercent = setting.SamplingPercent,
                enabled = setting.Enabled
            });

            if (response.IsSuccessStatusCode)
            {
                var updated = await response.Content.ReadFromJsonAsync<ObservabilitySetting>();
                if (updated is not null)
                {
                    var index = _settings!.FindIndex(s => s.Component == setting.Component);
                    if (index >= 0)
                    {
                        _settings[index] = updated;
                    }
                }
                Snackbar.Add($"{GetComponentDisplayName(setting.Component)} settings updated successfully", Severity.Success);
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Snackbar.Add($"Failed to update settings: {error}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to update observability setting {Component}", setting.Component);
            Snackbar.Add($"Error updating {GetComponentDisplayName(setting.Component)} settings", Severity.Error);
        }
    }

    private static string GetComponentDisplayName(string component) => component switch
    {
        "prometheus" => "Prometheus (Metrics)",
        "tempo" => "Tempo (Traces)",
        "loki" => "Loki (Logs)",
        _ => component
    };

    private class ObservabilitySetting
    {
        public int Id { get; set; }
        public string Component { get; set; } = string.Empty;
        public int RetentionDays { get; set; }
        public int SamplingPercent { get; set; }
        public bool Enabled { get; set; }
        public DateTime? UpdatedAt { get; set; }
        public string? UpdatedBy { get; set; }
    }
}
